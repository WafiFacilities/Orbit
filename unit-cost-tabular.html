<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Unit Cost Tabular</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@font-face { font-family: '72 Condensed'; src: local('72 Condensed'); }

body {
  font-family:'72 Condensed',Arial;
  margin:0;
  background:#f4f6f9;
}

.header {
  display:flex;
  align-items:center;
  padding:10px 20px;
  background:white;
  border-bottom:2px solid #e0e0e0;
}

.header img { height:40px; margin-right:15px; }

.header-title {
  font-size:22px;
  font-weight:bold;
  text-transform:uppercase;
}

.layout { display:flex; height:calc(100vh - 62px); }

.sidebar {
  width:220px;
  background:#404040;
  color:white;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}

.sidebar h4 { padding:10px 20px; }
.sidebar a { color:white; padding:10px 30px; text-decoration:none; }
.sidebar a:hover { background:#505050; }
.sidebar .logout { margin-top:auto; border-top:1px solid #555; }

.main { flex:1; padding:20px; overflow-y:auto; }

.filters {
  margin-bottom:15px;
}

select {
  padding:6px;
  border-radius:4px;
  border:1px solid #ccc;
  font-family:'72 Condensed';
}

table {
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:6px;
  overflow:hidden;
}

th, td {
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}

th {
  background:#76B531;
  color:white;
}

.total-row {
  font-weight:bold;
  background:#f2f2f2;
}

</style>
</head>

<body>

<div class="header">
  <img src="wafi-logo.png">
  <h1 class="header-title">FACILITIES â€“ ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>


<div class="main">

<h2>Unit Cost Tabular</h2>

<div class="filters">
  <select id="yearSelect" onchange="loadTable()">
    <option>2024</option>
    <option selected>2025</option>
    <option>2026</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th>Depot</th>
      <th>Cost Center</th>
      <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th>
      <th>May</th><th>Jun</th><th>Jul</th><th>Aug</th>
      <th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
      <th>YTD</th>
    </tr>
  </thead>

  <tbody id="tableBody"></tbody>
</table>

</div>
</div>

<script>
const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const depots = [
  {name:"SH-Shershah SSH", code:"SSH", center:"PK01000025"},
  {name:"SH-MHK-Mehmoodkot", code:"MHK", center:"PK01000027"},
  {name:"SH-Chaklala CKL", code:"CKL", center:"PK01000028"},
  {name:"SH-FBD-Gatti-M.Term", code:"GTI", center:"PK01000030"},
  {name:"SH-Tarujabba TJB", code:"TJB", center:"PK01000031"},
  {name:"SH-Karachi KMR", code:"KMR", center:"PK01000040"},
  {name:"SH-Shikarpur SKP", code:"SKP", center:"PK01000055"},
  {name:"SH-Daulatpur DLP", code:"DLP", center:"PK01000056"},
  {name:"SH-Bhakkar BKR", code:"BHK", center:"PK01000057"},
  {name:"SH-Vehari VHR", code:"VHR", center:"PK01000059"},
  {name:"SH-Machike MCH", code:"MCH", center:"PK01000061"},
  {name:"Total Facilities", code:"Total Facilities", center:""}
];

async function loadTable() {

  const year = document.getElementById("yearSelect").value;

  const volume = await supabaseClient.from("volume_data").select("*").match({year});
  const direct = await supabaseClient.from("direct_cost_data").select("*").match({year});
  const indirect = await supabaseClient.from("indirect_cost_data").select("*").match({year});

  const months = [...Array(12)].map((_,i)=>i+1);

  let html = "";

  depots.forEach(d => {

    let rowClass = d.code === "Total Facilities" ? "total-row" : "";

    html += `<tr class="${rowClass}">`;
    html += `<td>${d.name}</td>`;
    html += `<td>${d.center}</td>`;

    let cumulativeCost = 0;
    let cumulativeVolume = 0;

    months.forEach(m => {

      const v = volume.data.find(x=>x.month==m && x.depot==d.code)?.value || 0;
      const dc = direct.data.find(x=>x.month==m && x.depot==d.code)?.value || 0;
      const ic = indirect.data.find(x=>x.month==m && x.depot==d.code)?.value || 0;

      const unit = v ? ((dc + ic) / v).toFixed(2) : "-";

      html += `<td>${unit}</td>`;

      // accumulate only if volume exists
      // Include months even if value is zero
// Exclude only if volume is actually NULL

if (v !== null && v !== undefined) {
  cumulativeCost += (dc + ic);
  cumulativeVolume += v;
}

    });

    // YTD Calculation
    let ytdValue = "-";

    if(cumulativeVolume > 0) {
      ytdValue = (cumulativeCost / cumulativeVolume).toFixed(2);
    }

    html += `<td><b>${ytdValue}</b></td>`;

    html += `</tr>`;
  });

  document.getElementById("tableBody").innerHTML = html;
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

loadTable();

</script>

</body>
</html>
