<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>People – Employee Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@font-face { font-family: '72 Condensed'; src: local('72 Condensed'); }

body { font-family:'72 Condensed', Arial, sans-serif; margin:0; background:#f4f6f9; }

.header {
  display:flex;
  align-items:center;
  padding:10px 20px;
  background:white;
  border-bottom:2px solid #e0e0e0;
}

.header img { height:40px; margin-right:15px; }

.header-title {
  font-size:22px;
  color:#404040;
  font-weight:bold;
  text-transform:uppercase;
}

.layout { display:flex; height:calc(100vh - 62px); }

.sidebar {
  width:220px;
  background:#404040;
  color:white;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}

.sidebar h4 { padding:10px 20px; margin:0; font-size:14px; }
.sidebar a {
  color:white;
  padding:10px 30px;
  text-decoration:none;
  display:block;
}
.sidebar a:hover { background:#505050; }
.sidebar .logout { margin-top:auto; border-top:1px solid #555; }

.main { flex:1; padding:20px; overflow-y:auto; }

.form-box {
  background:white;
  padding:15px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

input, select {
  padding:6px;
  margin:4px;
  border-radius:4px;
  border:1px solid #ccc;
  font-family:'72 Condensed';
}

button {
  padding:6px 12px;
  border:none;
  border-radius:4px;
  background:#76B531;
  color:white;
  cursor:pointer;
}

button.danger { background:#e74c3c; }

table {
  width:100%;
  border-collapse:collapse;
  background:white;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

th, td {
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}

th {
  background:#76B531;
  color:white;
}
</style>
</head>

<body>

<div class="header">
  <img src="wafi-logo.png">
  <h1 class="header-title">FACILITIES – ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>

<div class="main">

<h2>Employee Management (Superusers Only)</h2>

<div id="adminContent"></div>

</div>
</div>

<script>

const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function isSuperUser(email){
  const { data } = await supabaseClient
    .from("superusers")
    .select("email")
    .eq("email", email);
  return data && data.length > 0;
}

async function init(){
  const { data } = await supabaseClient.auth.getSession();
  if(!data.session){
    window.location.replace("login.html");
    return;
  }

  const email = data.session.user.email;

  if(!(await isSuperUser(email))){
    document.getElementById("adminContent").innerHTML =
      "<h3>Access Denied – Superusers Only</h3>";
    return;
  }

  loadEmployees();
}

async function loadEmployees(){
  const { data, error } = await supabaseClient
    .from("employees")
    .select("*")
    .order("depot");

  if(error){
    alert(error.message);
    return;
  }

  render(data);
}

function render(employees){

  const depots = ["KMR","CKL","MCH","SKP","DLP","TJB","BHK","SSH","VHR"];
  const designations = [
    "FM",
    "TOS - Dispatch",
    "TOS - Receipt",
    "TOS - Other",
    "TOA - Dispatch",
    "TOA - Receipt",
    "TOA - Other"
  ];

  let html = `
  <div class="form-box">
    <h3>Add New Employee</h3>
    <input id="name" placeholder="Name">
    <input id="email" placeholder="Email">
    <select id="depot">
      ${depots.map(d=>`<option value="${d}">${d}</option>`).join("")}
    </select>
    <select id="designation">
      ${designations.map(d=>`<option value="${d}">${d}</option>`).join("")}
    </select>
    <input type="date" id="role_start_date">
    <button onclick="addEmployee()">Add</button>
  </div>

  <table>
  <tr>
    <th>Name</th>
    <th>Email</th>
    <th>Depot</th>
    <th>Designation</th>
    <th>Role Start</th>
    <th>Action</th>
  </tr>
  `;

  employees.forEach(emp=>{
    html += `
    <tr>
      <td><input value="${emp.name || ''}" onchange="updateField(${emp.id},'name',this.value)"></td>
      <td><input value="${emp.email || ''}" onchange="updateField(${emp.id},'email',this.value)"></td>
      <td>
        <select onchange="updateField(${emp.id},'depot',this.value)">
          ${depots.map(d=>`<option value="${d}" ${d===emp.depot?'selected':''}>${d}</option>`).join("")}
        </select>
      </td>
      <td>
        <select onchange="updateField(${emp.id},'designation',this.value)">
          ${designations.map(d=>`<option value="${d}" ${d===emp.designation?'selected':''}>${d}</option>`).join("")}
        </select>
      </td>
      <td>
        <input type="date" value="${emp.role_start_date || ''}"
        onchange="updateField(${emp.id},'role_start_date',this.value)">
      </td>
      <td>
        <button class="danger" onclick="deleteEmployee(${emp.id})">Delete</button>
      </td>
    </tr>`;
  });

  html += "</table>";

  document.getElementById("adminContent").innerHTML = html;
}

async function addEmployee(){

  const nameVal = document.getElementById("name").value.trim();
  const emailVal = document.getElementById("email").value.trim().toLowerCase();
  const depotVal = document.getElementById("depot").value;
  const designationVal = document.getElementById("designation").value;
  const roleStartVal = document.getElementById("role_start_date").value;

  if(!nameVal || !emailVal){
    alert("Name and Email required");
    return;
  }

  const { error } = await supabaseClient
    .from("employees")
    .insert([{
      name: nameVal,
      email: emailVal,
      depot: depotVal,
      designation: designationVal,
      role_start_date: roleStartVal || null
    }]);

  if(error){
    alert(error.message);
    return;
  }

  loadEmployees();
}

async function updateField(id, field, value){
  await supabaseClient
    .from("employees")
    .update({ [field]: value })
    .eq("id", id);
}

async function deleteEmployee(id){
  if(!confirm("Delete this employee?")) return;

  await supabaseClient
    .from("employees")
    .delete()
    .eq("id", id);

  loadEmployees();
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

init();

</script>

</body>
</html>
