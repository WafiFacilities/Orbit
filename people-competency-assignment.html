<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>People – Competency Assignment</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@font-face { font-family: '72 Condensed'; src: local('72 Condensed'); }

body { font-family:'72 Condensed', Arial; margin:0; background:#f4f6f9; }

.header { display:flex; align-items:center; padding:10px 20px; background:white; border-bottom:2px solid #e0e0e0; }
.header img { height:40px; margin-right:15px; }
.header-title { font-size:22px; font-weight:bold; text-transform:uppercase; }

.layout { display:flex; height:calc(100vh - 62px); }

.sidebar {
  width:220px; background:#404040; color:white;
  display:flex; flex-direction:column; padding-top:20px;
}
.sidebar h4 { padding:10px 20px; margin:0; font-size:14px; }
.sidebar a { color:white; padding:10px 30px; text-decoration:none; display:block; }
.sidebar a:hover { background:#505050; }
.sidebar .logout { margin-top:auto; border-top:1px solid #555; }

.main { flex:1; padding:20px; overflow-y:auto; }

table {
  width:100%;
  border-collapse:collapse;
  background:white;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#76B531; color:white; }

.toggle-yes { background:#d4edda; }
.toggle-no { background:#f8d7da; }

button {
  padding:4px 8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#76B531;
  color:white;
}

</style>
</head>

<body>

<div class="header">
  <img src="wafi-logo.png">
  <h1 class="header-title">FACILITIES – ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>

<div class="main">

<h2>Competency Assignment Matrix</h2>

<div id="matrixTable"></div>

</div>
</div>

<script>

const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function isSuperUser(email){
  const { data } = await supabaseClient
    .from("superusers")
    .select("*")
    .eq("email", email);
  return data.length > 0;
}

async function load(){

  const { data: sessionData } = await supabaseClient.auth.getSession();
  if(!sessionData.session){
    window.location.replace("login.html");
    return;
  }

  const userEmail = sessionData.session.user.email;
  const superUser = await isSuperUser(userEmail);

  const { data: competencyTypes } =
    await supabaseClient.from("competency_types").select("*").order("id");

  const { data: matrix } =
    await supabaseClient.from("designation_competency_matrix").select("*");

  const designations =
    [...new Set(matrix.map(m => m.designation))];

  let html = "<table><tr><th>Designation</th>";

  competencyTypes.forEach(c=>{
    html += `<th>${c.name}</th>`;
  });

  html += "</tr>";

  designations.forEach(desig => {

    html += `<tr><td><b>${desig}</b></td>`;

    competencyTypes.forEach(c=>{

     const row = matrix.find(m =>
  m.designation === desig &&
  m.competency_type_id === c.id
);

const applicable = row?.is_applicable === true;

html += `<td class="${applicable ? 'toggle-yes':'toggle-no'}">`;

if(superUser){

  if(row){
    // Existing row → toggle update
    html += `
      <button onclick="toggle(${row.id}, ${applicable}, '${desig}', ${c.id})">
        ${applicable ? 'YES' : 'NO'}
      </button>
    `;
  } else {
    // Missing row → create new
    html += `
      <button onclick="toggle(null, false, '${desig}', ${c.id})">
        NO
      </button>
    `;
  }

} else {
  html += applicable ? "YES" : "NO";
}

html += "</td>";

    });

    html += "</tr>";
  });

  html += "</table>";

  document.getElementById("matrixTable").innerHTML = html;
}

async function toggle(id, currentValue, designation, competencyTypeId){

  // If row exists → update
  if(id){

    const { error } = await supabaseClient
      .from("designation_competency_matrix")
      .update({ is_applicable: !currentValue })
      .eq("id", id);

    if(error){
      alert(error.message);
      return;
    }

  } else {
    // Row does not exist → insert new
    const { error } = await supabaseClient
      .from("designation_competency_matrix")
      .insert({
        designation: designation,
        competency_type_id: competencyTypeId,
        is_applicable: true
      });

    if(error){
      alert(error.message);
      return;
    }
  }

  load();
}


async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

load();

</script>

</body>
</html>
