<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financial Dashboard â€“ Category View</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
@font-face { font-family: '72 Condensed'; src: local('72 Condensed'); }

body { font-family:'72 Condensed', Arial; margin:0; background:#f4f6f9; }

.header {
  display:flex;
  align-items:center;
  padding:10px 20px;
  background:white;
  border-bottom:2px solid #e0e0e0;
}

.header img { height:40px; margin-right:15px; }
.header-title { font-size:22px; font-weight:bold; text-transform:uppercase; }

.layout { display:flex; height:calc(100vh - 62px); }

.sidebar {
  width:220px;
  background:#404040;
  color:white;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}

.sidebar h4 { padding:10px 20px; margin:0; font-size:14px; }

.sidebar a {
  color:white;
  padding:10px 30px;
  text-decoration:none;
  display:block;
}

.sidebar a:hover { background:#505050; }

.sidebar .logout {
  margin-top:auto;
  border-top:1px solid #555;
}

.main {
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.filters {
  display:flex;
  gap:15px;
  margin-bottom:20px;
}

.filters select {
  padding:6px;
  border-radius:4px;
  border:1px solid #ccc;
  font-family:'72 Condensed';
}

.chart-box {
  background:white;
  padding:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  border-radius:6px;
  max-width:1400px;
  height:650px; /* ðŸ”¥ Taller chart */
}

</style>
</head>

<body>

<div class="header">
  <img src="wafi-logo.png">
  <h1 class="header-title">FACILITIES â€“ ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

  <div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>

  <div class="main">

    <h2>Category View â€“ Depot Split</h2>

    <div class="filters">
      <select id="filterYear"></select>
      <select id="filterCategory"></select>
    </div>

    <div class="chart-box">
      <canvas id="financialChart"></canvas>
    </div>

  </div>
</div>

<script>

const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let allData = [];
let chartInstance = null;

async function load(){

  const { data: sessionData } = await supabaseClient.auth.getSession();
  if(!sessionData.session){
    window.location.replace("login.html");
    return;
  }

  const { data, error } = await supabaseClient
    .from("financial_actuals")
    .select("*")
    .range(0, 50000);

  if(error){
    console.log(error);
    return;
  }

  allData = data;

  populateFilters();
  renderChart();
}

function populateFilters(){

  const years = [...new Set(allData.map(d => d.year))].sort();
  const categories = [...new Set(allData.map(d => d.category))].sort();

  const yearSelect = document.getElementById("filterYear");
  const catSelect = document.getElementById("filterCategory");

  yearSelect.innerHTML = "";
  catSelect.innerHTML = `<option value="ALL">All Categories</option>`;

  years.forEach(y=>{
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  });

  categories.forEach(c=>{
    catSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });

  yearSelect.value = years[years.length - 1];
}

function renderChart(){

  const year = document.getElementById("filterYear").value;
  const category = document.getElementById("filterCategory").value;

  const filtered = allData.filter(d =>
    d.year == year &&
    (category === "ALL" || d.category === category)
  );

  const depots = [...new Set(filtered.map(d => d.cost_center_name))];

  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  const datasets = depots.map(depot => {

    const monthlyData = [];

    for(let m = 1; m <= 12; m++){

      const total = filtered
        .filter(d => d.month == m && d.cost_center_name === depot)
        .reduce((sum,row)=> sum + Number(row.actual_amount || 0),0);

      monthlyData.push(total);
    }

    return {
      label: depot,
      data: monthlyData
    };
  });

  if(chartInstance) chartInstance.destroy();

  const ctx = document.getElementById("financialChart").getContext("2d");

  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: months,
      datasets: datasets
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ position:'bottom' },
        datalabels:{
          anchor:'end',
          align:'end',
          color:'#000',
          font:{ weight:'bold' },
          formatter: function(value, context){

            const monthIndex = context.dataIndex;

            const total = context.chart.data.datasets
              .map(ds => ds.data[monthIndex])
              .reduce((a,b)=> a + b,0);

            // Only show label on top dataset
            if(context.datasetIndex === context.chart.data.datasets.length - 1){
              return total ? total.toLocaleString() : '';
            }
            return '';
          }
        }
      },
      scales:{
        x:{ stacked:true },
        y:{ stacked:true }
      }
    },
    plugins:[ChartDataLabels]
  });
}

document.getElementById("filterYear")
  .addEventListener("change", renderChart);

document.getElementById("filterCategory")
  .addEventListener("change", renderChart);

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

load();

</script>

</body>
</html>
