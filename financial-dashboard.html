<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financial Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
@font-face { font-family: '72 Condensed'; src: local('72 Condensed'); }

body {
  font-family:'72 Condensed',Arial;
  margin:0;
  background:#f4f6f9;
}

.header {
  display:flex;
  align-items:center;
  padding:10px 20px;
  background:white;
  border-bottom:2px solid #e0e0e0;
}

.header img { height:40px; margin-right:15px; }

.header-title {
  font-size:22px;
  font-weight:bold;
  text-transform:uppercase;
}

.layout { display:flex; height:calc(100vh - 62px); }

.sidebar {
  width:220px;
  background:#404040;
  color:white;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}

.sidebar h4 { padding:10px 20px; }
.sidebar a { color:white; padding:10px 30px; text-decoration:none; }
.sidebar a:hover { background:#505050; }
.sidebar .logout { margin-top:auto; border-top:1px solid #555; }

.main { flex:1; padding:20px; overflow-y:auto; }

.filters { display:flex; gap:15px; margin-bottom:20px; }

select {
  padding:6px;
  border-radius:4px;
  border:1px solid #ccc;
  font-family:'72 Condensed';
}

.chart-box {
  background:white;
  padding:10px;
  border-radius:6px;
  margin-bottom:15px;
}

canvas { max-height:260px; }

.formula-text {
  font-size:13px;
  color:#555;
  margin-top:6px;
}
</style>
</head>

<body>

<div class="header">
  <img src="wafi-logo.png">
  <h1 class="header-title">FACILITIES – ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>

<div class="main">

<h2>Financial Dashboard</h2>

<div class="filters">
  <select id="yearSelect" onchange="loadDashboard()">
    <option>2024</option>
    <option selected>2025</option>
    <option>2026</option>
  </select>

  <select id="terminalSelect" onchange="loadDashboard()">
    <option value="Total Facilities">Facilities Total</option>
    <option>KMR</option>
    <option>CKL</option>
    <option>MCH</option>
    <option>SKP</option>
    <option>DLP</option>
    <option>TJB</option>
    <option>BHK</option>
    <option>SSH</option>
    <option>VHR</option>
    <option>GTI</option>
    <option>MMK</option>
  </select>
</div>

<div class="chart-box">
  <h3>Monthly Unit Cost (Absolute Monthly) + Volume</h3>
  <canvas id="absoluteChart"></canvas>

  <p class="formula-text">
    Unit Cost Target Formula:  
    <b>Target = 90% × (Current Year YTD Total Cost ÷ Previous Year YTD Total Volume)</b>
  </p>
</div>

<div class="chart-box">
  <h3>Monthly Unit Cost (YTD) + Volume</h3>
  <canvas id="ytdChart"></canvas>
</div>

</div>
</div>

<script>

const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let absChart = null;
let ytdChart = null;

async function loadDashboard() {

  const year = parseInt(document.getElementById("yearSelect").value);
  const prevYear = year - 1;

  const terminal = document.getElementById("terminalSelect").value;

  const volume = await supabaseClient.from("volume_data").select("*").match({year, depot: terminal});
  const direct = await supabaseClient.from("direct_cost_data").select("*").match({year, depot: terminal});
  const indirect = await supabaseClient.from("indirect_cost_data").select("*").match({year, depot: terminal});

  const prevVolume = await supabaseClient
    .from("volume_data")
    .select("*")
    .match({year: prevYear, depot: terminal});

  const months = [...Array(12)].map((_,i)=>i+1);

  let vol=[], dir=[], indir=[], unit=[];

  months.forEach(m=>{
    const v = volume.data.find(x=>x.month==m)?.value || 0;
    const d = direct.data.find(x=>x.month==m)?.value || 0;
    const i = indirect.data.find(x=>x.month==m)?.value || 0;

    vol.push(v);
    dir.push(d);
    indir.push(i);

    unit.push(v ? ((d+i)/v).toFixed(2) : 0);
  });

  // ----- TARGET CALCULATION -----

  let prevVolArr = months.map(m =>
    prevVolume.data.find(x=>x.month==m)?.value || 0
  );

  let targetUnit = [];

  for(let i=0; i<12; i++){

    let ytdCost = 0;
    let ytdPrevVol = 0;

    for(let j=0; j<=i; j++){
      ytdCost += dir[j] + indir[j];
      ytdPrevVol += prevVolArr[j];
    }

    targetUnit.push(
      ytdPrevVol ? (0.9 * (ytdCost / ytdPrevVol)).toFixed(2) : null
    );
  }

  // ----- YTD Calculations -----

  let ytdUnit=[];
  let cumCost=0, cumVol=0;

  months.forEach((m,i)=>{
    cumCost += dir[i] + indir[i];
    cumVol += vol[i];

    ytdUnit.push(cumVol ? (cumCost/cumVol).toFixed(2) : 0);
  });

  renderCharts(vol, unit, ytdUnit, targetUnit);
}

function renderCharts(vol, unit, ytdUnit, targetUnit) {

  const labels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  if(absChart) absChart.destroy();
  if(ytdChart) ytdChart.destroy();

  absChart = new Chart(document.getElementById("absoluteChart"), {
    type:"line",
    data:{
      labels,
      datasets:[

        {
          label:"Unit Cost",
          data:unit,
          borderColor:"#76B531",
          yAxisID:'y',
          datalabels:{
            color:"#000",
            anchor:"end",
            align:"top"
          }
        },

        {
          label:"Target Unit Cost",
          data:targetUnit,
          borderColor:"#e67e22",
          borderDash:[6,6],
          borderWidth:2,
          pointRadius:0,
          yAxisID:'y',
          datalabels:{ display:false }
        },

        {
          label:"Volume",
          data:vol,
          type:'bar',
          backgroundColor:"#e6e6e6",
          yAxisID:'y1',
          datalabels:{ display:false }
        }
      ]
    },
    options:{
      plugins:{ datalabels:{ display:true }},
      scales:{
        y:{ position:'left', title:{display:true,text:'Unit Cost'} },
        y1:{ position:'right', title:{display:true,text:'Volume'} }
      }
    },
    plugins:[ChartDataLabels]
  });

  ytdChart = new Chart(document.getElementById("ytdChart"), {
    type:"line",
    data:{
      labels,
      datasets:[

        {
          label:"YTD Unit Cost",
          data:ytdUnit,
          borderColor:"#76B531",
          yAxisID:'y',
          datalabels:{
            color:"#000",
            anchor:"end",
            align:"top"
          }
        },

        {
          label:"Volume",
          data:vol,
          type:'bar',
          backgroundColor:"#e6e6e6",
          yAxisID:'y1',
          datalabels:{ display:false }
        }
      ]
    },
    options:{
      plugins:{ datalabels:{ display:true }},
      scales:{
        y:{ position:'left', title:{display:true,text:'Unit Cost'} },
        y1:{ position:'right', title:{display:true,text:'Volume'} }
      }
    },
    plugins:[ChartDataLabels]
  });
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

loadDashboard();

</script>

</body>
</html>
