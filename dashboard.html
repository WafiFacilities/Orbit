<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facilities Orbit – Executive Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@font-face { font-family:'72 Condensed'; src:local('72 Condensed'); }
body{font-family:'72 Condensed',Arial;margin:0;background:#f4f6f9;}

.header{display:flex;align-items:center;padding:10px 20px;background:white;border-bottom:2px solid #e0e0e0;}
.header img{height:40px;margin-right:15px;}
.header-title{font-size:22px;font-weight:bold;text-transform:uppercase;}

.layout{display:flex;height:calc(100vh - 62px);}

.sidebar{
 width:220px;background:#404040;color:white;
 display:flex;flex-direction:column;padding-top:20px;
}
.sidebar h4{padding:10px 20px;}
.sidebar a{color:white;padding:10px 30px;text-decoration:none;}
.sidebar a:hover{background:#505050;}
.sidebar .logout{margin-top:auto;border-top:1px solid #555;}

.main{flex:1;padding:20px;overflow-y:auto;}

.section-title{
 margin-top:25px;
 margin-bottom:15px;
 font-size:24px;
 font-weight:700;
 border-bottom:3px solid #76B531;
 padding-bottom:6px;
}

.kpi-container{
 display:grid;
 grid-template-columns:repeat(4,1fr);
 gap:15px;margin-bottom:20px;
}

.kpi{
 background:white;padding:20px;border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
 text-align:center;
}

.kpi h3{
 margin:0;font-size:42px;font-weight:700;color:#76B531;
}

.impact-title{font-weight:bold;font-size:16px;margin-bottom:12px;}
.impact-line{display:flex;justify-content:space-between;margin-bottom:6px;}
.impact-line .value{color:#76B531;font-weight:bold;font-size:20px}

.filter-bar{margin-bottom:20px;}
.filter-bar select{padding:6px;border-radius:4px;border:1px solid #ccc;}

.chart-box{
 background:white;padding:15px;border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
 margin-bottom:25px;
}

.impact-card{
 background:white;
 padding:20px;
 border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
 margin-bottom:30px;
}

.impact-card canvas{
 height:300px !important;
 margin-bottom:10px;
}

.top-table{
 width:100%;
 border-collapse:collapse;
}
.top-table th{
 background:#76B531;color:white;padding:6px;font-size:13px;
}
.top-table td{
 border:1px solid #ddd;padding:6px;font-size:13px;
}

</style>
</head>

<body>

<div class="header">
<img src="wafi-logo.png">
<h1 class="header-title">FACILITIES – ORBIT DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">
<h4>INITIATIVE</h4>
<a href="index.html">List View</a>
<a href="add-initiative.html">Add Initiative</a>
<a href="dashboard.html">Dashboard</a>
<a href="#" onclick="logout()" class="logout">Logout</a>
</div>

<div class="main">

<h2>Executive Dashboard</h2>

<div class="filter-bar">
<label>Terminal:</label>
<select id="terminalFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>KMR</option><option>CKL</option><option>MCH</option>
<option>SKP</option><option>DLP</option><option>TJB</option>
<option>BHK</option><option>SSH</option><option>VHR</option>
<option>GTI</option><option>MMK</option>
</select>

<label style="margin-left:20px">Year:</label>
<select id="yearFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>2025</option>
<option>2026</option>
<option>2027</option>
<option>2028</option>
<option>2029</option>
<option>2030</option>
</select>
</div>


<!-- OPERATIONAL -->
<div class="section-title">Operational Summary</div>
<div class="kpi-container">
<div class="kpi"><h3 id="total">0</h3><p>Total</p></div>
<div class="kpi"><h3 id="underReview">0</h3><p>Under Review</p></div>
<div class="kpi"><h3 id="open">0</h3><p>Open</p></div>
<div class="kpi"><h3 id="closed">0</h3><p>Closed</p></div>
</div>


<!-- IMPACT KPI -->
<div class="section-title">Impact (Realized vs Pipeline)</div>
<div class="kpi-container">

<div class="kpi">
<div class="impact-title">Cost Saving (PKR)</div>
<div class="impact-line"><span>Realized</span><span class="value" id="cs_realized">0</span></div>
<div class="impact-line"><span>Pipeline</span><span class="value" id="cs_pipeline">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">Cost Avoidance (PKR)</div>
<div class="impact-line"><span>Realized</span><span class="value" id="ca_realized">0</span></div>
<div class="impact-line"><span>Pipeline</span><span class="value" id="ca_pipeline">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">G2G Improvement (Minutes)</div>
<div class="impact-line"><span>Realized</span><span class="value" id="g2g_realized">0</span></div>
<div class="impact-line"><span>Pipeline</span><span class="value" id="g2g_pipeline">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">Capacity Enhancement (KT)</div>
<div class="impact-line"><span>Realized</span><span class="value" id="cap_realized">0</span></div>
<div class="impact-line"><span>Pipeline</span><span class="value" id="cap_pipeline">0</span></div>
</div>

</div>


<!-- ================================================= -->
<!-- IMPACT ANALYTICS -->
<!-- ================================================= -->

<div class="section-title">Impact Analytics</div>

<div id="impactAnalytics"></div>


</div>
</div>

<script>

const supabaseClient = supabase.createClient(
"https://kqhbvmqxrwwspopwckah.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8"
);

async function init(){
 const {data}=await supabaseClient.auth.getSession();
 if(!data.session) window.location="login.html";
 loadKPIs();
}
init();


async function loadKPIs(){

 const terminal=terminalFilter.value;
 const year=yearFilter.value;

 let query=supabaseClient.from("initiatives").select("*");

 if(terminal) query=query.eq("terminal_name",terminal);
 if(year) query=query.eq("year",year);

 const {data}=await query;
 if(!data) return;

 total.innerText=data.length;
 underReview.innerText=data.filter(i=>i.status==="Under Review").length;
 open.innerText=data.filter(i=>i.status?.startsWith("Open")).length;
 closed.innerText=data.filter(i=>i.status==="Closed").length;

 const realized=data.filter(i=>i.status==="Closed");
 const pipeline=data.filter(i=>i.status!=="Closed" && i.status!=="Dropped");

 const sum=(list,type)=>list.filter(i=>i.impact_type===type)
 .reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0);

 cs_realized.innerText=sum(realized,"Cost Saving (PKR)").toLocaleString();
 cs_pipeline.innerText=sum(pipeline,"Cost Saving (PKR)").toLocaleString();

 ca_realized.innerText=sum(realized,"Cost Avoidance (PKR)").toLocaleString();
 ca_pipeline.innerText=sum(pipeline,"Cost Avoidance (PKR)").toLocaleString();

 g2g_realized.innerText=sum(realized,"G2G Improvement (Minutes)").toLocaleString();
 g2g_pipeline.innerText=sum(pipeline,"G2G Improvement (Minutes)").toLocaleString();

 cap_realized.innerText=sum(realized,"Capacity Enhancement (KT)").toLocaleString();
 cap_pipeline.innerText=sum(pipeline,"Capacity Enhancement (KT)").toLocaleString();

 renderImpactAnalytics(data);
}



function renderImpactAnalytics(data){

 const container=document.getElementById("impactAnalytics");
 container.innerHTML="";

 const types=[
 "Cost Saving (PKR)",
 "Cost Avoidance (PKR)",
 "G2G Improvement (Minutes)",
 "Capacity Enhancement (KT)"
 ];

 types.forEach(type=>{

   const id=type.replace(/[^a-z]/gi,"");

   container.innerHTML+=`
   <div class="impact-card">
     <h3>${type}</h3>
     <canvas id="${id}_chart"></canvas>
     <h4>Top 10 Initiatives</h4>
     <table class="top-table" id="${id}_table"></table>
   </div>
   `;

   buildImpactChart(data,type,`${id}_chart`);
   buildTopTable(data,type,`${id}_table`);
 });

}



function buildImpactChart(data,type,canvasId){

 const filtered=data.filter(i=>i.impact_type===type);
 const terminals=[...new Set(filtered.map(i=>i.terminal_name))];

 const realized=[];
 const pipeline=[];

 terminals.forEach(t=>{
   const list=filtered.filter(i=>i.terminal_name===t);

   realized.push(
     list.filter(i=>i.status==="Closed")
     .reduce((s,i)=>s+(parseFloat(i.impact_amount)||0),0)
   );

   pipeline.push(
     list.filter(i=>i.status!=="Closed" && i.status!=="Dropped")
     .reduce((s,i)=>s+(parseFloat(i.impact_amount)||0),0)
   );
 });

 new Chart(document.getElementById(canvasId),{
 type:"bar",
 data:{
 labels:terminals,
 datasets:[
 {label:"Realized",data:realized,backgroundColor:"#2ecc71"},
 {label:"Pipeline",data:pipeline,backgroundColor:"#f1c40f"}
 ]
 },
 options:{responsive:true,maintainAspectRatio:false}
 });
}



function buildTopTable(data,type,tableId){

 const rows=data
 .filter(i=>i.impact_type===type && i.status!=="Dropped")
 .sort((a,b)=>(b.impact_amount||0)-(a.impact_amount||0))
 .slice(0,10);

 let html=`<tr><th>Terminal</th><th>Initiative</th><th>Value</th></tr>`;

 rows.forEach(r=>{
 html+=`<tr>
 <td>${r.terminal_name}</td>
 <td>${r.initiative_name}</td>
 <td>${Number(r.impact_amount||0).toLocaleString()}</td>
 </tr>`;
 });

 document.getElementById(tableId).innerHTML=html;
}



async function logout(){
 await supabaseClient.auth.signOut();
 window.location="login.html";
}

</script>

</body>
</html>
