<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facilities Orbit — Executive Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
@font-face{font-family:'72 Condensed';src:local('72 Condensed');}
body{font-family:'72 Condensed',Arial;margin:0;background:#f4f6f9;}

.header{display:flex;align-items:center;padding:10px 20px;background:white;border-bottom:2px solid #e0e0e0;}
.header img{height:40px;margin-right:15px;}
.header-title{font-size:22px;font-weight:bold;text-transform:uppercase;}

.layout{display:flex;height:calc(100vh - 62px);}
.sidebar{width:220px;background:#404040;color:white;display:flex;flex-direction:column;padding-top:20px;}
.sidebar h4{padding:10px 20px;margin:0;}
.sidebar a{color:white;padding:10px 30px;text-decoration:none;}
.sidebar a:hover{background:#505050;}
.sidebar .logout{margin-top:auto;border-top:1px solid #555;}

.main{flex:1;padding:20px;overflow-y:auto;}

.section-title{
margin-top:25px;
margin-bottom:10px;
font-size:18px;
font-weight:bold;
border-bottom:2px solid #76B531;
padding-bottom:4px;
}

.kpi-grid{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:12px;
}

.kpi{
background:white;
padding:14px;
border-radius:6px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
text-align:center;
}

.kpi h3{margin:0;color:#76B531;}
.kpi small{color:#777;}

.chart-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
gap:18px;
}

.chart-box{
background:white;
padding:15px;
border-radius:6px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
height:420px;
}

.filter-bar{margin-bottom:15px;}
select{padding:6px;border-radius:4px;border:1px solid #ccc;}

table{
width:100%;
border-collapse:collapse;
background:white;
}
th,td{padding:8px;border:1px solid #ddd;text-align:center;}
th{background:#76B531;color:white;}
</style>
</head>

<body>

<div class="header">
<img src="wafi-logo.png">
<h1 class="header-title">FACILITIES ORBIT — EXECUTIVE DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">
<h4>INITIATIVE</h4>
<a href="index.html">List View</a>
<a href="add-initiative.html">Add Initiative</a>
<a href="dashboard.html">Dashboard</a>
<a href="#" onclick="logout()" class="logout">Logout</a>
</div>

<div class="main">

<h2>Executive KPIs</h2>

<div class="filter-bar">
Terminal:
<select id="terminalFilter"></select>

Year:
<select id="yearFilter"></select>
</div>

<div class="section-title">Operational Summary</div>

<div class="kpi-grid">
<div class="kpi"><h3 id="k_total">0</h3><small>Total</small></div>
<div class="kpi"><h3 id="k_review">0</h3><small>Under Review</small></div>
<div class="kpi"><h3 id="k_open">0</h3><small>Open</small></div>
<div class="kpi"><h3 id="k_closed">0</h3><small>Closed</small></div>
<div class="kpi"><h3 id="k_overdue">0</h3><small>Overdue</small></div>
</div>

<div class="section-title">Impact (Realized vs Pipeline)</div>

<div class="kpi-grid">
<div class="kpi"><h3 id="cs_r">0</h3><small>Cost Saving Realized</small></div>
<div class="kpi"><h3 id="cs_p">0</h3><small>Cost Saving Pipeline</small></div>
<div class="kpi"><h3 id="ca_r">0</h3><small>Cost Avoidance Realized</small></div>
<div class="kpi"><h3 id="ca_p">0</h3><small>Cost Avoidance Pipeline</small></div>
<div class="kpi"><h3 id="g2g_r">0</h3><small>G2G Realized</small></div>
<div class="kpi"><h3 id="g2g_p">0</h3><small>G2G Pipeline</small></div>
<div class="kpi"><h3 id="cap_r">0</h3><small>Capacity Realized</small></div>
<div class="kpi"><h3 id="cap_p">0</h3><small>Capacity Pipeline</small></div>
</div>

<div class="section-title">Analytics</div>

<div class="chart-grid">
<div class="chart-box"><canvas id="pipelineChart"></canvas></div>
<div class="chart-box"><canvas id="trendChart"></canvas></div>
<div class="chart-box"><canvas id="funnelChart"></canvas></div>
<div class="chart-box"><canvas id="heatmapChart"></canvas></div>
</div>

<div class="section-title">Terminal Ranking</div>
<table>
<thead>
<tr>
<th>Terminal</th>
<th>Cost Saving (PKR)</th>
<th>Cost Avoidance (PKR)</th>
<th>G2G (Minutes)</th>
<th>Capacity (KT)</th>
</tr>
</thead>
<tbody id="rankingTable"></tbody>
</table>

</div>
</div>

<script>
Chart.register(ChartDataLabels);

const supabaseClient = window.supabase.createClient(
  "https://kqhbvmqxrwwspopwckah.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8"
);


let allData=[];
let charts=[];

function destroyCharts(){
charts.forEach(c=>c.destroy());
charts=[];
}

async function init(){

const {data}=await supabaseClient.auth.getSession();
if(!data.session) location="login.html";

const {data:rows}=await supabaseClient.from("initiatives").select("*");
allData=rows;

populateFilters();
render();
}

function populateFilters(){

const terminals=[...new Set(allData.map(i=>i.terminal_name))];
const years=[...new Set(allData.map(i=>i.year))].sort();

terminalFilter.innerHTML=`<option value="">All</option>`+
terminals.map(t=>`<option>${t}</option>`).join("");

yearFilter.innerHTML=`<option value="">All</option>`+
years.map(y=>`<option>${y}</option>`).join("");
}

function filtered(){
return allData.filter(i=>
(!terminalFilter.value||i.terminal_name===terminalFilter.value)&&
(!yearFilter.value||i.year==yearFilter.value)
);
}

function sum(list,type){
return list.filter(i=>i.impact_type===type)
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0);
}

function render(){

destroyCharts();

const data=filtered();
const today=new Date().toISOString().split("T")[0];

k_total.innerText=data.length;
k_review.innerText=data.filter(i=>i.status==="Under Review").length;
k_open.innerText=data.filter(i=>i.status.startsWith("Open")).length;
k_closed.innerText=data.filter(i=>i.status==="Closed").length;
k_overdue.innerText=data.filter(i=>i.target_date && i.target_date<today && i.status!=="Closed").length;

const realized=data.filter(i=>i.status==="Closed");
const pipeline=data.filter(i=>i.status!=="Closed" && i.status!=="Dropped");

cs_r.innerText=sum(realized,"Cost Saving (PKR)").toLocaleString();
cs_p.innerText=sum(pipeline,"Cost Saving (PKR)").toLocaleString();
ca_r.innerText=sum(realized,"Cost Avoidance (PKR)").toLocaleString();
ca_p.innerText=sum(pipeline,"Cost Avoidance (PKR)").toLocaleString();
g2g_r.innerText=sum(realized,"G2G Improvement (Minutes)").toLocaleString();
g2g_p.innerText=sum(pipeline,"G2G Improvement (Minutes)").toLocaleString();
cap_r.innerText=sum(realized,"Capacity Enhancement (KT)").toLocaleString();
cap_p.innerText=sum(pipeline,"Capacity Enhancement (KT)").toLocaleString();

buildPipelineChart(realized,pipeline);
buildTrend(data);
buildFunnel(data);
buildHeatmap(data);
buildRanking(realized);
}

function buildPipelineChart(r,p){
charts.push(new Chart(pipelineChart,{
type:"bar",
data:{
labels:["Cost Saving","Cost Avoidance","G2G","Capacity"],
datasets:[
{label:"Realized",data:[
sum(r,"Cost Saving (PKR)"),
sum(r,"Cost Avoidance (PKR)"),
sum(r,"G2G Improvement (Minutes)"),
sum(r,"Capacity Enhancement (KT)")
]},
{label:"Pipeline",data:[
sum(p,"Cost Saving (PKR)"),
sum(p,"Cost Avoidance (PKR)"),
sum(p,"G2G Improvement (Minutes)"),
sum(p,"Capacity Enhancement (KT)")
]}
]}
}));
}

function buildTrend(data){

const years=[...new Set(data.map(i=>i.year))].sort();
const vals=years.map(y=>data.filter(i=>i.year==y && i.status==="Closed")
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0));

charts.push(new Chart(trendChart,{
type:"line",
data:{labels:years,datasets:[{label:"Realized Impact",data:vals}]}
}));
}

function buildFunnel(data){

const stages=["Under Review","Open - Initiated","Open - Under Execution","Closed"];
const vals=stages.map(s=>data.filter(i=>i.status===s).length);

charts.push(new Chart(funnelChart,{
type:"bar",
data:{labels:stages,datasets:[{data:vals}]}
}));
}

function buildHeatmap(data){

const terminals=[...new Set(data.map(i=>i.terminal_name))];
const statuses=["Under Review","Open - Initiated","Open - Under Execution","Closed"];

const matrix=terminals.map(t=>statuses.map(s=>
data.filter(i=>i.terminal_name===t && i.status===s).length));

charts.push(new Chart(heatmapChart,{
type:"bar",
data:{
labels:statuses,
datasets:terminals.map((t,i)=>({
label:t,
data:matrix[i],
stack:"x"
}))
},
options:{scales:{x:{stacked:true},y:{stacked:true}}}
}));
}

function buildRanking(data){

const terminals=[...new Set(data.map(i=>i.terminal_name))];
rankingTable.innerHTML="";

terminals.forEach(t=>{
const list=data.filter(i=>i.terminal_name===t);
rankingTable.innerHTML+=`
<tr>
<td>${t}</td>
<td>${sum(list,"Cost Saving (PKR)").toLocaleString()}</td>
<td>${sum(list,"Cost Avoidance (PKR)").toLocaleString()}</td>
<td>${sum(list,"G2G Improvement (Minutes)").toLocaleString()}</td>
<td>${sum(list,"Capacity Enhancement (KT)").toLocaleString()}</td>
</tr>`;
});
}

terminalFilter.onchange=render;
yearFilter.onchange=render;

async function logout(){
await supabaseClient.auth.signOut();
location="login.html";
}

init();
</script>
</body>
</html>

