<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facilities Orbit – Executive Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
@font-face{font-family:'72 Condensed';src:local('72 Condensed');}
body{font-family:'72 Condensed',Arial;margin:0;background:#f4f6f9;}

.header{display:flex;align-items:center;padding:10px 20px;background:white;border-bottom:2px solid #e0e0e0;}
.header img{height:40px;margin-right:15px;}
.header-title{font-size:22px;font-weight:bold;text-transform:uppercase;}

.layout{display:flex;height:calc(100vh - 62px);}
.sidebar{width:220px;background:#404040;color:white;display:flex;flex-direction:column;padding-top:20px;}
.sidebar h4{padding:10px 20px;margin:0;}
.sidebar a{color:white;padding:10px 30px;text-decoration:none;}
.sidebar a:hover{background:#505050;}
.sidebar .logout{margin-top:auto;border-top:1px solid #555;}

.main{flex:1;padding:20px;overflow-y:auto;}

.section-title{
margin-top:25px;margin-bottom:10px;
font-size:18px;font-weight:bold;color:#404040;
border-bottom:2px solid #76B531;padding-bottom:5px;
}

.kpi-container{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:15px;margin-bottom:20px;
}

.kpi{
background:white;padding:15px;border-radius:6px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
text-align:center;
}

.kpi h3{margin:0;color:#76B531;font-size:22px;}

.chart-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
gap:20px;
}

.chart-box{
background:white;padding:15px;border-radius:6px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.filter-bar{margin-bottom:20px;}
.filter-bar select{padding:6px;border-radius:4px;border:1px solid #ccc;}

table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border:1px solid #ddd;text-align:center;}
th{background:#76B531;color:white;}
</style>
</head>

<body>

<div class="header">
<img src="wafi-logo.png">
<h1 class="header-title">FACILITIES – ONE STOP DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">
<h4>INITIATIVE</h4>
<a href="index.html">List View</a>
<a href="add-initiative.html">Add Initiative</a>
<a href="dashboard.html">Dashboard</a>
<a href="#" onclick="logout()" class="logout">Logout</a>
</div>

<div class="main">

<h2>Executive Dashboard</h2>

<div class="filter-bar">
Terminal:
<select id="terminalFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>KMR</option><option>CKL</option><option>MCH</option>
<option>SKP</option><option>DLP</option><option>TJB</option>
<option>BHK</option><option>SSH</option><option>VHR</option>
<option>GTI</option><option>MMK</option>
</select>

Year:
<select id="yearFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>2025</option>
<option>2026</option>
<option>2027</option>
<option>2028</option>
<option>2029</option>
<option>2030</option>
</select>
</div>

<div class="section-title">Operational Summary</div>

<div class="kpi-container">
<div class="kpi"><h3 id="total">0</h3>Total</div>
<div class="kpi"><h3 id="underReview">0</h3>Under Review</div>
<div class="kpi"><h3 id="open">0</h3>Open</div>
<div class="kpi"><h3 id="closed">0</h3>Closed</div>
</div>

<div class="section-title">Impact Summary</div>

<div class="kpi-container">
<div class="kpi"><h3 id="cs">0</h3>Cost Saving (PKR)</div>
<div class="kpi"><h3 id="ca">0</h3>Cost Avoidance (PKR)</div>
<div class="kpi"><h3 id="kt">0</h3>Capacity Enhancement (KT)</div>
<div class="kpi"><h3 id="g2g">0</h3>G2G Improvement (Min)</div>
</div>

<div class="section-title">Analytics</div>

<div class="chart-grid">

<div class="chart-box"><h3>Realized vs Pipeline</h3><canvas id="gauge"></canvas></div>
<div class="chart-box"><h3>Impact Trend by Year</h3><canvas id="trend"></canvas></div>
<div class="chart-box"><h3>Stage Funnel</h3><canvas id="funnel"></canvas></div>
<div class="chart-box"><h3>Live Progress Heatmap</h3><canvas id="heatmap"></canvas></div>

</div>

<div class="section-title">Terminal Ranking</div>
<div class="chart-box">
<table id="ranking">
<thead>
<tr><th>Rank</th><th>Terminal</th><th>Total Impact</th><th>Closed</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>
</div>

<script>
Chart.register(ChartDataLabels);

const supabase=supabase.createClient(
"https://kqhbvmqxrwwspopwckah.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8"
);

async function loadKPIs(){

const terminal=terminalFilter.value;
const year=yearFilter.value;

let query=supabase.from("initiatives").select("*");

if(terminal) query=query.eq("terminal_name",terminal);
if(year) query=query.eq("year",year);

const {data}=await query;
if(!data) return;

/* KPI */
total.innerText=data.length;
underReview.innerText=data.filter(i=>i.status==="Under Review").length;
open.innerText=data.filter(i=>i.status.startsWith("Open")).length;
closed.innerText=data.filter(i=>i.status==="Closed").length;

/* Impact totals */
const sum=t=>data.filter(i=>i.impact_type===t)
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0);

cs.innerText=sum("Cost Saving (PKR)").toLocaleString();
ca.innerText=sum("Cost Avoidance (PKR)").toLocaleString();
kt.innerText=sum("Capacity Enhancement (KT)").toLocaleString();
g2g.innerText=sum("G2G Improvement (Minutes)").toLocaleString();

buildGauge(data);
buildTrend(data);
buildFunnel(data);
buildRanking(data);
buildHeatmap(data);
}

/* GAUGE */
function buildGauge(data){
const realized=data.filter(i=>i.status==="Closed")
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0);

const pipeline=data.filter(i=>i.status!=="Closed"&&i.status!=="Dropped")
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0);

new Chart(gauge,{
type:"doughnut",
data:{labels:["Realized","Pipeline"],
datasets:[{data:[realized,pipeline],
backgroundColor:["#76B531","#f39c12"]}]},
options:{cutout:"70%"}
});
}

/* TREND */
function buildTrend(data){
const years=[...new Set(data.map(i=>i.year))].sort();
const totals=years.map(y=>data.filter(i=>i.year===y)
.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0));

new Chart(trend,{
type:"line",
data:{labels:years,datasets:[{data:totals,borderColor:"#76B531"}]}
});
}

/* FUNNEL */
function buildFunnel(data){
const stages=["Under Review","Open - Initiated","Open - Under MOC","Open - Under Execution","Closed"];
const counts=stages.map(s=>data.filter(i=>i.status===s).length);

new Chart(funnel,{
type:"bar",
data:{labels:stages,datasets:[{data:counts,backgroundColor:"#3498db"}]},
options:{indexAxis:"y"}
});
}

/* RANKING */
function buildRanking(data){
const terminals=[...new Set(data.map(i=>i.terminal_name))];

const ranking=terminals.map(t=>{
const list=data.filter(i=>i.terminal_name===t);
return{
terminal:t,
impact:list.reduce((a,b)=>a+(parseFloat(b.impact_amount)||0),0),
closed:list.filter(i=>i.status==="Closed").length
};
}).sort((a,b)=>b.impact-a.impact);

const tbody=document.querySelector("#ranking tbody");
tbody.innerHTML="";
ranking.forEach((r,i)=>{
tbody.innerHTML+=`<tr>
<td>${i+1}</td>
<td>${r.terminal}</td>
<td>${r.impact.toLocaleString()}</td>
<td>${r.closed}</td>
</tr>`;
});
}

/* HEATMAP */
function buildHeatmap(data){
const terminals=[...new Set(data.map(i=>i.terminal_name))];
const stages=[...new Set(data.map(i=>i.status))];

const datasets=stages.map(stage=>({
label:stage,
data:terminals.map(t=>data.filter(i=>i.terminal_name===t&&i.status===stage).length)
}));

new Chart(heatmap,{
type:"bar",
data:{labels:terminals,datasets:datasets},
options:{scales:{x:{stacked:true},y:{stacked:true}}}
});
}

async function logout(){
await supabase.auth.signOut();
location="login.html";
}

loadKPIs();
</script>
</body>
</html>
