<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facilities Orbit – Executive Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@font-face { font-family:'72 Condensed'; src:local('72 Condensed'); }
body{font-family:'72 Condensed',Arial;margin:0;background:#f4f6f9;}

.header{display:flex;align-items:center;padding:10px 20px;background:white;border-bottom:2px solid #e0e0e0;}
.header img{height:40px;margin-right:15px;}
.header-title{font-size:22px;font-weight:bold;text-transform:uppercase;}

.layout{display:flex;height:calc(100vh - 62px);}
.sidebar{width:220px;background:#404040;color:white;display:flex;flex-direction:column;padding-top:20px;}
.sidebar a{color:white;padding:10px 30px;text-decoration:none;}
.sidebar a:hover{background:#505050;}
.sidebar .logout{margin-top:auto;border-top:1px solid #555;}

.main{flex:1;padding:20px;overflow-y:auto;}

.section-title{
 margin-top:25px;
 font-size:22px;
 font-weight:bold;
 border-bottom:3px solid #76B531;
 padding-bottom:6px;
}

/* KPI */
.kpi-container{
 display:grid;
 grid-template-columns:repeat(4,1fr);
 gap:15px;margin-top:15px;
}

.kpi{
 background:white;padding:20px;border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
 text-align:center;
}

.kpi h3{
 margin:0;
 font-size:40px;
 color:#76B531;
}

.kpi p{
 margin-top:5px;
 color:#666;
 font-weight:600;
}

/* impact KPI */
.impact-title{font-weight:bold;margin-bottom:10px;}
.impact-line{display:flex;justify-content:space-between;margin-bottom:6px;}
.impact-line .value{color:#76B531;font-weight:bold;font-size:18px}

/* 4 column sections */
.section-grid{
 display:grid;
 grid-template-columns:repeat(4,1fr);
 gap:20px;
 margin-top:20px;
}

.card{
 background:white;
 padding:15px;
 border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.card-title{
 font-weight:bold;
 text-align:center;
 margin-bottom:10px;
}

.card canvas{
 width:100%!important;
 height:260px!important;
}

table{width:100%;border-collapse:collapse;font-size:13px;}
th{background:#76B531;color:white;padding:6px;}
td{border:1px solid #ddd;padding:6px;}

.filter-bar{margin-bottom:20px;}
.filter-bar select{padding:6px;border-radius:4px;border:1px solid #ccc;}
</style>
</head>

<body>

<div class="header">
<img src="wafi-logo.png">
<h1 class="header-title">FACILITIES – ORBIT DASHBOARD</h1>
</div>

<div class="layout">

<div class="sidebar">
<a href="index.html">List View</a>
<a href="add-initiative.html">Add Initiative</a>
<a href="#" onclick="logout()" class="logout">Logout</a>
</div>

<div class="main">

<h2>Executive Dashboard</h2>

<div class="filter-bar">
Terminal:
<select id="terminalFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>KMR</option><option>CKL</option><option>MCH</option>
<option>SKP</option><option>DLP</option><option>TJB</option>
<option>BHK</option><option>SSH</option><option>VHR</option>
<option>GTI</option><option>MMK</option>
</select>

Year:
<select id="yearFilter" onchange="loadKPIs()">
<option value="">All</option>
<option>2025</option><option>2026</option><option>2027</option>
<option>2028</option><option>2029</option><option>2030</option>
</select>
</div>

<!-- OPERATIONAL SUMMARY -->
<div class="section-title">Operational Summary</div>

<div class="kpi-container">
<div class="kpi"><h3 id="total">0</h3><p>Total</p></div>
<div class="kpi"><h3 id="underReview">0</h3><p>Under Review</p></div>
<div class="kpi"><h3 id="open">0</h3><p>Open</p></div>
<div class="kpi"><h3 id="closed">0</h3><p>Closed</p></div>
</div>

<!-- IMPACT KPI -->
<div class="section-title">Impact (Realized vs Pipeline)</div>

<div class="kpi-container">
<div class="kpi">
<div class="impact-title">Cost Saving (PKR)</div>
<div class="impact-line">Realized <span id="cs_realized" class="value">0</span></div>
<div class="impact-line">Pipeline <span id="cs_pipeline" class="value">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">Cost Avoidance (PKR)</div>
<div class="impact-line">Realized <span id="ca_realized" class="value">0</span></div>
<div class="impact-line">Pipeline <span id="ca_pipeline" class="value">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">G2G Improvement (Minutes)</div>
<div class="impact-line">Realized <span id="g2g_realized" class="value">0</span></div>
<div class="impact-line">Pipeline <span id="g2g_pipeline" class="value">0</span></div>
</div>

<div class="kpi">
<div class="impact-title">Capacity Enhancement (KT)</div>
<div class="impact-line">Realized <span id="cap_realized" class="value">0</span></div>
<div class="impact-line">Pipeline <span id="cap_pipeline" class="value">0</span></div>
</div>
</div>

<!-- CHARTS -->
<div class="section-title">Impact by Terminal</div>

<div class="section-grid">
<div class="card"><div class="card-title">Cost Saving</div><canvas id="chart_cs"></canvas></div>
<div class="card"><div class="card-title">Cost Avoidance</div><canvas id="chart_ca"></canvas></div>
<div class="card"><div class="card-title">G2G Improvement</div><canvas id="chart_g2g"></canvas></div>
<div class="card"><div class="card-title">Capacity Enhancement</div><canvas id="chart_cap"></canvas></div>
</div>

<!-- TOP INITIATIVES -->
<div class="section-title">Top Initiatives</div>

<div class="section-grid">
<div class="card"><div class="card-title">Cost Saving</div><table id="table_cs"></table></div>
<div class="card"><div class="card-title">Cost Avoidance</div><table id="table_ca"></table></div>
<div class="card"><div class="card-title">G2G Improvement</div><table id="table_g2g"></table></div>
<div class="card"><div class="card-title">Capacity Enhancement</div><table id="table_cap"></table></div>
</div>

</div>
</div>

<script>

const supabaseClient = window.supabase.createClient(
"https://kqhbvmqxrwwspopwckah.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8"
);

let charts={};

function cleanStatus(s){
 return (s||"").toLowerCase().trim();
}

function isClosed(s){ return cleanStatus(s).startsWith("closed"); }
function isOpen(s){ return cleanStatus(s).startsWith("open"); }
function isDropped(s){ return cleanStatus(s).startsWith("dropped"); }
function isUnderReview(s){ return cleanStatus(s)==="under review"; }

function matchImpact(type,text){
 return (text||"").toLowerCase().includes(type);
}

async function loadKPIs(){

 let query=supabaseClient.from("initiatives").select("*");
 if(terminalFilter.value) query=query.eq("terminal_name",terminalFilter.value);
 if(yearFilter.value) query=query.eq("year",yearFilter.value);

 const {data}=await query;
 if(!data) return;

 total.innerText=data.length;
 underReview.innerText=data.filter(i=>isUnderReview(i.status)).length;
 open.innerText=data.filter(i=>isOpen(i.status)).length;
 closed.innerText=data.filter(i=>isClosed(i.status)).length;

 const realized=data.filter(i=>isClosed(i.status));
 const pipeline=data.filter(i=>!isClosed(i.status) && !isDropped(i.status));

 const sum=(list,key)=>list
   .filter(i=>matchImpact(key,i.impact_type))
   .reduce((s,i)=>s+(parseFloat(i.impact_amount)||0),0);

 cs_realized.innerText=sum(realized,"saving").toLocaleString();
 cs_pipeline.innerText=sum(pipeline,"saving").toLocaleString();

 ca_realized.innerText=sum(realized,"avoid").toLocaleString();
 ca_pipeline.innerText=sum(pipeline,"avoid").toLocaleString();

 g2g_realized.innerText=sum(realized,"g2g").toLocaleString();
 g2g_pipeline.innerText=sum(pipeline,"g2g").toLocaleString();

 cap_realized.innerText=sum(realized,"capacity").toLocaleString();
 cap_pipeline.innerText=sum(pipeline,"capacity").toLocaleString();

 buildChart(data,"saving","chart_cs");
 buildChart(data,"avoid","chart_ca");
 buildChart(data,"g2g","chart_g2g");
 buildChart(data,"capacity","chart_cap");

 buildTable(data,"saving","table_cs");
 buildTable(data,"avoid","table_ca");
 buildTable(data,"g2g","table_g2g");
 buildTable(data,"capacity","table_cap");
}

function buildChart(data,key,id){

 const filtered=data.filter(i=>matchImpact(key,i.impact_type));
 const terminals=[...new Set(filtered.map(i=>i.terminal_name))];

 const realized=[];
 const pipeline=[];

 terminals.forEach(t=>{
   const list=filtered.filter(i=>i.terminal_name===t);

   realized.push(list.filter(i=>isClosed(i.status))
     .reduce((s,i)=>s+(parseFloat(i.impact_amount)||0),0));

   pipeline.push(list.filter(i=>!isClosed(i.status) && !isDropped(i.status))
     .reduce((s,i)=>s+(parseFloat(i.impact_amount)||0),0));
 });

 if(charts[id]) charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
   type:"bar",
   data:{
     labels:terminals,
     datasets:[
       {label:"Realized",data:realized,backgroundColor:"#2ecc71"},
       {label:"Pipeline",data:pipeline,backgroundColor:"#f1c40f"}
     ]
   },
   options:{responsive:true,maintainAspectRatio:false}
 });
}

function buildTable(data,key,id){

 const rows=data
   .filter(i=>matchImpact(key,i.impact_type) && !isDropped(i.status))
   .sort((a,b)=>(b.impact_amount||0)-(a.impact_amount||0))
   .slice(0,10);

 let html="<tr><th>Terminal</th><th>Initiative</th><th>Value</th></tr>";

 rows.forEach(r=>{
   html+=`<tr>
   <td>${r.terminal_name}</td>
   <td>${r.initiative_name}</td>
   <td>${Number(r.impact_amount||0).toLocaleString()}</td>
   </tr>`;
 });

 document.getElementById(id).innerHTML=html;
}

async function logout(){
 await supabaseClient.auth.signOut();
 window.location="login.html";
}

loadKPIs();

</script>

</body>
</html>
