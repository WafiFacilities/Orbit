<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financial Data Entry</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

@font-face {
  font-family: '72 Condensed';
  src: local('72 Condensed');
}

body {
  font-family: '72 Condensed', Arial;
  margin:0;
  background:#f4f6f9;
}

/* HEADER */
.header {
  display:flex;
  align-items:center;
  padding:10px 20px;
  background:white;
  border-bottom:2px solid #e0e0e0;
}

.header img {
  height:40px;
  margin-right:15px;
}

.header-title {
  font-size:22px;
  font-weight:bold;
  text-transform:uppercase;
}

/* LAYOUT */
.layout {
  display:flex;
  height:calc(100vh - 62px);
}

/* SIDEBAR */
.sidebar {
  width:220px;
  background:#404040;
  color:white;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}

.sidebar h4 {
  padding:10px 20px;
  margin:0;
  font-size:14px;
}

.sidebar a {
  color:white;
  padding:10px 30px;
  text-decoration:none;
  display:block;
}

.sidebar a:hover {
  background:#505050;
}

.sidebar .logout {
  margin-top:auto;
  border-top:1px solid #555;
}

/* MAIN CONTENT */
.main {
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.table-box {
  background:white;
  padding:15px;
  margin-bottom:20px;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

table {
  width:100%;
  border-collapse:collapse;
}

th, td {
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}

th {
  background:#76B531;
  color:white;
}

input {
  width:90%;
  padding:4px;
  text-align:center;
  font-family:'72 Condensed';
}

.save-btn {
  padding:10px 20px;
  background:#76B531;
  color:white;
  border:none;
  cursor:pointer;
  border-radius:4px;
}

.msg {
  margin-top:10px;
  font-weight:bold;
}

</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="wafi-logo.png" alt="Wafi Logo">
  <h1 class="header-title">FACILITIES â€“ ONE STOP DASHBOARD</h1>
</div>

<!-- LAYOUT WRAPPER (IMPORTANT) -->
<div class="layout">

  <!-- SIDEBAR -->
 <div class="sidebar">

  <h4>INITIATIVE</h4>
  <a href="index.html">List View</a>
  <a href="add-initiative.html">Add New Initiative</a>
  <a href="dashboard.html">Dashboard</a>

  <h4>FINANCIAL</h4>
  <a href="financial-dashboard.html">Unit Cost Graph</a>
  <a href="unit-cost-tabular.html">Unit Cost Tabular</a>
  <a href="financial-summary.html">Financial Performance</a>
  <a href="financial-monthly-performance.html">Depot Yearly Performance</a>
  <a href="financial-dashboard-overview.html">Category Wise</a>
  <a href="financial-dashboard-category.html">Depot Wise</a>
  <a href="financial-entry.html">Financial Data Entry</a>

  <h4>PEOPLE</h4>
  <a href="people-employees.html">Competency Tracker</a>
  <a href="people-admin.html">Employee Admin</a>
  <a href="people-competency-assignment.html">Competency Assignment</a>

  <a href="#" onclick="logout()" class="logout">Logout</a>

</div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <h2>Financial Data Entry</h2>

    <label>Select Year:</label>
    <select id="yearSelect" onchange="loadYear()">
      <option>2024</option>
      <option>2025</option>
      <option selected>2026</option>
    </select>

    <h3>Volume (Liters)</h3>
    <div class="table-box">
      <table id="volumeTable"></table>
    </div>

    <h3>Direct Cost (PKR)</h3>
    <div class="table-box">
      <table id="directTable"></table>
    </div>

    <h3>Indirect Cost (PKR)</h3>
    <div class="table-box">
      <table id="indirectTable"></table>
    </div>

    <button class="save-btn" onclick="saveAll()">Save All Changes</button>

    <p id="msg" class="msg"></p>

  </div>

</div>

<script>

// Supabase Config
const supabaseUrl = "https://kqhbvmqxrwwspopwckah.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxaGJ2bXF4cnd3c3BvcHdja2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTYyOTAsImV4cCI6MjA4NjI5MjI5MH0.uKfFMK7GBtCR8P5n7hsJlN72-w5h0oyOhuaySphmns8";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const months = [
  "Jan","Feb","Mar","Apr","May","Jun",
  "Jul","Aug","Sep","Oct","Nov","Dec"
];

// Superuser check
async function checkSuperUser(){

  const session = await supabaseClient.auth.getSession();

  if(!session.data.session){
    window.location = "login.html";
    return;
  }

  const email = session.data.session.user.email;

  const {data} = await supabaseClient
    .from('superusers')
    .select('*')
    .eq('email', email);

  if(data.length === 0){
    alert("Only superusers can access this page");
    window.location = "index.html";
  }
}

// Load year tables
async function loadYear(){
  await loadTable("volume_data","volumeTable");
  await loadTable("direct_cost_data","directTable");
  await loadTable("indirect_cost_data","indirectTable");
}

// Load individual table
async function loadTable(table, elementId){

  const year = document.getElementById("yearSelect").value;

  const {data} = await supabaseClient
    .from(table)
    .select("*")
    .eq("year", year);

  if(!data || data.length === 0){
    document.getElementById(elementId).innerHTML =
      "<tr><td>No data for this year</td></tr>";
    return;
  }

  let depots = [...new Set(data.map(d => d.depot))];

  let html = `<tr>
      <th>Depot</th>
      <th>Cost Center</th>
      ${months.map(m => `<th>${m}</th>`).join("")}
  </tr>`;

  for(let depot of depots){

    let rowData = data.filter(d => d.depot === depot);

    html += `<tr>
      <td>${depot}</td>
      <td>${rowData[0]?.cost_center || ""}</td>`;

    for(let i = 1; i <= 12; i++){

      let val = rowData.find(r => r.month === i)?.value || "";

      html += `
      <td>
        <input
          data-table="${table}"
          data-depot="${depot}"
          data-cost="${rowData[0]?.cost_center || ""}"
          data-month="${i}"
          value="${val}"
        >
      </td>`;
    }

    html += "</tr>";
  }

  document.getElementById(elementId).innerHTML = html;
}

// Save all
async function saveAll(){

  const year = document.getElementById("yearSelect").value;

  let inputs = document.querySelectorAll("input");

  for(let inp of inputs){

    let table = inp.dataset.table;
    let depot = inp.dataset.depot;
    let cost = inp.dataset.cost;
    let month = inp.dataset.month;
    let value = inp.value;

    await supabaseClient
      .from(table)
      .upsert({
        year: year,
        month: month,
        depot: depot,
        cost_center: cost,
        value: value || null,
        updated_at: new Date().toISOString()
      });
  }

  document.getElementById("msg").innerText = "Saved Successfully!";
}

// Logout
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

// Init
checkSuperUser();
loadYear();

</script>

</body>
</html>
